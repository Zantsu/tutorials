<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>g5k-campaign-tutorial.rb</title>
  <link rel="stylesheet" href="./../../docco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div id="jump_to">
    Jump To &hellip;
    <div id="jump_wrapper">
      <div id="jump_page">
          <a class="source" href="curl-tutorial.html">curl-tutorial.sh</a>
          <a class="source" href="g5k-campaign-tutorial.html">g5k-campaign-tutorial.rb</a>
          <a class="source" href="resources-status-2.0.html">resources-status-2.0.rb</a>
          <a class="source" href="restfully-tutorial.html">restfully-tutorial.rb</a>
          <a class="source" href="../sid/resources-status-sid.html">resources-status-sid.rb</a>
      </div>
    </div>
  </div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>g5k-campaign-tutorial.rb</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-1'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-1">&#182;</a>
        </div>

      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-2'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-2">&#182;</a>
        </div>
        <p>This tutorial will show you how to use the <a href="http://g5k-campaign.gforge.inria.fr">g5k-campaign</a>
tool to easily build a whole experiment workflow.</p>

<p>This tool is built on the <a href="http://github.com/grid5000/restfully">Restfully</a> library,
and provide a higher level of abstraction, with support for parallel
execution of reservations, deployments, and resource configuration.</p>

<p>You can download the source file for this tutorial from here:
<a href="https://github.com/grid5000/tutorials/blob/master/api/2.0/g5k-campaign-tutorial.rb">https://github.com/grid5000/tutorials/blob/master/api/2.0/g5k-campaign-tutorial.rb</a>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-Prerequisites'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Prerequisites">&#182;</a>
        </div>
        <h2>Prerequisites</h2>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-4'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-4">&#182;</a>
        </div>
        <p>You need to install the <code>g5k-campaign</code> library. Assuming you have <code>Ruby</code> and
<code>rubygems</code> (1.3.5+) already installed on your system, this can be done with:</p>

<pre><code>gem install g5k-campaign \
&mdash;source http://g5k-campaign.gforge.inria.fr/pkg
</code></pre>

<p>The library comes with an executable.
You can get a better feel of what it can do by displaying the usage help:</p>

<pre><code>g5k-campaign -h
</code></pre>

<p>If you do not provide any option, it will launch a campaign using the default parameters, which are:</p>

<ul>
<li>submit a 1-hour job on one node of the <code>rennes</code> site, and</li>
<li>deploy the <code>lenny-x64-base</code> environment on the reserved node.</li>
</ul>

<p>Note that you must have an SSH key installed on your machine, with the
public part of that key in the authorized keys of the
<code>access.grid5000.fr</code> machine.
If this is not the case, follow the first steps as described at <a href="http://pkeck.myweb.uga.edu/ssh/">http://pkeck.myweb.uga.edu/ssh/</a>, or in the <a href="https://www.grid5000.fr/mediawiki/index.php/SSH">Grid'5000 wiki</a>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-Building_your_own_engine'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Building_your_own_engine">&#182;</a>
        </div>
        <h2>Building your own engine</h2>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-6'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-6">&#182;</a>
        </div>
        <p>You can play a little with the various options of the default engine, but
it is probably more useful to create your own engine that will execute
specific actions before, after or at any state of your experiment.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-7'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-7">&#182;</a>
        </div>
        <p>Let&rsquo;s start with a simple engine:</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="k">class</span> <span class="nc">SimpleCustomEngine</span> <span class="o">&lt;</span> <span class="no">Grid5000</span><span class="o">::</span><span class="no">Campaign</span><span class="o">::</span><span class="no">Engine</span></pre></div>
      </td>
    </tr>
    <tr id='section-8'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-8">&#182;</a>
        </div>
        <p>We override some of the parameters.
The complete list of options can be found <a href="http://g5k-campaign.gforge.inria.fr/Grid5000/Campaign/Engine.html">here</a>.
Note that every parameter given on the command-line will always overwrite those defined in the engine.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">set</span> <span class="ss">:environment</span><span class="p">,</span> <span class="s2">&quot;lenny-x64-base&quot;</span>
  <span class="n">set</span> <span class="ss">:resources</span><span class="p">,</span> <span class="s2">&quot;nodes=2&quot;</span>
  <span class="n">set</span> <span class="ss">:walltime</span><span class="p">,</span> <span class="mi">7200</span>
  <span class="n">set</span> <span class="ss">:site</span><span class="p">,</span> <span class="s2">&quot;nancy&quot;</span></pre></div>
      </td>
    </tr>
    <tr id='section-9'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-9">&#182;</a>
        </div>
        <p>By default, all the reserved nodes are released when the engine terminates.
Here we want to keep the nodes available after the end of the workflow, so that we can still use them.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">set</span> <span class="ss">:no_cleanup</span><span class="p">,</span> <span class="kp">true</span></pre></div>
      </td>
    </tr>
    <tr id='section-10'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-10">&#182;</a>
        </div>
        <p>Define an action to execute before reserving resources:</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">before</span> <span class="ss">:reserve!</span> <span class="k">do</span> <span class="o">|</span><span class="n">env</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="o">|</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span> <span class="s2">&quot;Executed before reservation!&quot;</span></pre></div>
      </td>
    </tr>
    <tr id='section-11'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-11">&#182;</a>
        </div>
        <p>For all hooks, we must always return <code>env</code>.
Otherwise the hook is considered to have failed.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">env</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-12'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-12">&#182;</a>
        </div>
        <p>Define an action to execute after deploying resources:</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">after</span> <span class="ss">:deployment!</span> <span class="k">do</span> <span class="o">|</span><span class="n">env</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="o">|</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span> <span class="s2">&quot;[</span><span class="si">#{</span><span class="n">env</span><span class="o">[</span><span class="ss">:site</span><span class="o">]</span><span class="si">}</span><span class="s2">] Nodes have been deployed: </span><span class="si">#{</span><span class="n">env</span><span class="o">[</span><span class="ss">:nodes</span><span class="o">].</span><span class="n">inspect</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">env</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-13'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-13">&#182;</a>
        </div>
        <p>Define an action to execute on the installation phase (i.e. after reservation and deployment are done):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">on</span> <span class="ss">:install!</span> <span class="k">do</span> <span class="o">|</span><span class="n">env</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="o">|</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span> <span class="s2">&quot;[</span><span class="si">#{</span><span class="n">env</span><span class="o">[</span><span class="ss">:site</span><span class="o">]</span><span class="si">}</span><span class="s2">] Installing additional software on the nodes...&quot;</span></pre></div>
      </td>
    </tr>
    <tr id='section-14'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-14">&#182;</a>
        </div>
        <p>We SSH to each node to install additional software.
Note that this is a naive approach that only works for small numbers of nodes.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">env</span><span class="o">[</span><span class="ss">:nodes</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">node</span><span class="o">|</span>
      <span class="n">ssh</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;root&quot;</span><span class="p">,</span> <span class="ss">:timeout</span> <span class="o">=&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">ssh</span><span class="o">|</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">ssh</span><span class="o">.</span><span class="n">exec!</span><span class="p">(</span><span class="s2">&quot;apt-get update &amp;&amp; apt-get install -y ganglia-monitor bonnie++&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span> <span class="n">output</span></pre></div>
      </td>
    </tr>
    <tr id='section-15'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-15">&#182;</a>
        </div>
        <p>You can easily copy files on your nodes if you wish.
As an example, here we just send a file containing the list of
reserved nodes.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="n">nodes_file</span> <span class="o">=</span> <span class="s2">&quot;/tmp/</span><span class="si">#{</span><span class="n">env</span><span class="o">[</span><span class="ss">:job</span><span class="o">][</span><span class="s1">&#39;uid&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">ssh</span><span class="o">.</span><span class="n">scp</span><span class="o">.</span><span class="n">upload!</span><span class="p">(</span><span class="no">StringIO</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">env</span><span class="o">[</span><span class="ss">:nodes</span><span class="o">].</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)),</span> <span class="n">nodes_file</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">env</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-16'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-16">&#182;</a>
        </div>
        <p>Define an action to execute after the nodes have been reserved, deployed, and installed:</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">on</span> <span class="ss">:execute!</span> <span class="k">do</span> <span class="o">|</span><span class="n">env</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="o">|</span></pre></div>
      </td>
    </tr>
    <tr id='section-17'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-17">&#182;</a>
        </div>
        <p>Use the :multi option if you want to run SSH commands in parallel.
This is better than sequentially SSHing to nodes, but for large number
of nodes, you should probably connect to the frontend and launch a
<a href="taktuk.gforge.inria.fr/"><code>taktuk</code></a> process for efficient execution.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">ssh</span><span class="p">(</span><span class="n">env</span><span class="o">[</span><span class="ss">:nodes</span><span class="o">]</span><span class="p">,</span> <span class="s2">&quot;root&quot;</span><span class="p">,</span> <span class="ss">:multi</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:timeout</span> <span class="o">=&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">ssh</span><span class="o">|</span></pre></div>
      </td>
    </tr>
    <tr id='section-18'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-18">&#182;</a>
        </div>
        <p>Run the <code>bonnie++</code> benchmark on each node, and publish a custom metric every 5 secs (in a real experiment you&rsquo;d want to send something else than $RANDOM):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">cmd</span> <span class="o">=</span> <span class="sx">%Q{nohup sh -c &#39;(while true; do gmetric --name custom_metric_</span><span class="si">#{</span><span class="n">env</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="si">}</span><span class="sx"> --type uint16 --value $RANDOM; sleep 20; done &amp;) &amp;&amp; bonnie++ -u root -d /tmp 1&gt;/dev/null 2&gt;&amp;1&#39; &gt;/dev/null &amp;}</span>
      <span class="n">logger</span><span class="o">.</span><span class="n">info</span> <span class="s2">&quot;[</span><span class="si">#{</span><span class="n">env</span><span class="o">[</span><span class="ss">:site</span><span class="o">]</span><span class="si">}</span><span class="s2">] Executing command: </span><span class="si">#{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">&quot;</span>

      <span class="n">ssh</span><span class="o">.</span><span class="n">exec</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-19'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-19">&#182;</a>
        </div>
        <p>In the multi version, we must explicitly tell when the commands are
ready to be launched in parallel on all nodes.
See <a href="http://net-ssh.github.com/multi/v1/api/index.html">http://net-ssh.github.com/multi/v1/api/index.html</a> for more info.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">ssh</span><span class="o">.</span><span class="n">loop</span>
    <span class="k">end</span>
    <span class="n">env</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-20'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-20">&#182;</a>
        </div>
        <p>The following is just an example of what we can do once everything is setup and running.
Here we&rsquo;ll just poll the values for two timeseries (our custom metric and <code>cpu_idle</code>).
We use the <a href="https://api.grid5000.fr/2.0/metrics/help/index.html">Metrology API</a> for that.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">after</span> <span class="ss">:execute!</span> <span class="k">do</span> <span class="o">|</span><span class="n">env</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="o">|</span>
    <span class="n">from</span> <span class="o">=</span> <span class="n">env</span><span class="o">[</span><span class="ss">:job</span><span class="o">][</span><span class="s1">&#39;submitted_at&#39;</span><span class="o">]</span>
    <span class="n">resolution</span> <span class="o">=</span> <span class="mi">15</span>
    <span class="mi">10</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span>
      <span class="n">to</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">to_i</span><span class="o">-</span><span class="n">resolution</span>
      <span class="o">[</span><span class="s2">&quot;custom_metric_</span><span class="si">#{</span><span class="n">env</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;cpu_idle&quot;</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">metric</span><span class="o">|</span>
        <span class="k">begin</span>
          <span class="n">logger</span><span class="o">.</span><span class="n">info</span> <span class="s2">&quot;[</span><span class="si">#{</span><span class="n">env</span><span class="o">[</span><span class="ss">:site</span><span class="o">]</span><span class="si">}</span><span class="s2">] Fetching timeseries for </span><span class="si">#{</span><span class="n">metric</span><span class="si">}</span><span class="s2"> metric...&quot;</span></pre></div>
      </td>
    </tr>
    <tr id='section-21'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-21">&#182;</a>
        </div>
        <p>In all engines you have access to a <code>connection</code> handler, which is
a <code>Restfully::Session</code> object that you can use to access the
Grid'5000 API.</p>

<p>See the Restfully tutorial for more details.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>          <span class="n">connection</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">sites</span><span class="o">[</span><span class="n">env</span><span class="o">[</span><span class="ss">:site</span><span class="o">].</span><span class="n">to_sym</span><span class="o">].</span><span class="n">metrics</span><span class="o">[</span><span class="n">metric</span><span class="o">.</span><span class="n">to_sym</span><span class="o">].</span>
          <span class="n">timeseries</span><span class="p">(</span>
            <span class="ss">:query</span> <span class="o">=&gt;</span> <span class="p">{</span>
              <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="n">env</span><span class="o">[</span><span class="ss">:nodes</span><span class="o">].</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">),</span>
              <span class="ss">:resolution</span> <span class="o">=&gt;</span> <span class="n">resolution</span><span class="p">,</span>
              <span class="ss">:from</span> <span class="o">=&gt;</span> <span class="n">from</span><span class="p">,</span>
              <span class="ss">:to</span> <span class="o">=&gt;</span> <span class="n">to</span>
            <span class="p">}</span>
          <span class="p">)</span><span class="o">.</span><span class="n">reload</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">timeseries</span><span class="o">|</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span> <span class="o">[</span><span class="n">env</span><span class="o">[</span><span class="ss">:site</span><span class="o">]</span><span class="p">,</span> <span class="n">timeseries</span><span class="o">[</span><span class="s1">&#39;uid&#39;</span><span class="o">]</span><span class="p">,</span> <span class="n">metric</span><span class="o">].</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot; - &quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span> <span class="n">timeseries</span><span class="o">[</span><span class="s1">&#39;values&#39;</span><span class="o">].</span><span class="n">inspect</span>
          <span class="k">end</span>
        <span class="k">rescue</span> <span class="o">=&gt;</span> <span class="n">e</span>
          <span class="n">logger</span><span class="o">.</span><span class="n">warn</span> <span class="s2">&quot;[</span><span class="si">#{</span><span class="n">env</span><span class="o">[</span><span class="ss">:site</span><span class="o">]</span><span class="si">}</span><span class="s2">] Error when fetching </span><span class="si">#{</span><span class="n">metric</span><span class="si">}</span><span class="s2"> metric: </span><span class="si">#{</span><span class="n">e</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">end</span>
      <span class="k">end</span>
      <span class="nb">sleep</span> <span class="mi">15</span>
    <span class="k">end</span>
    <span class="n">env</span>
  <span class="k">end</span>

<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-Running_your_engines'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Running_your_engines">&#182;</a>
        </div>
        <h2>Running your engines</h2>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-23'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-23">&#182;</a>
        </div>
        <p>To execute this engine, you have two solutions.
Either you copy the <a href="#section-2">source file</a> on your machine, and then launch it as followsi (please replace <code>login</code> with your login):</p>

<pre><code>g5k-campaign -i path/to/file &mdash;gateway access.grid5000.fr \
-u login
SimpleCustomEngine
</code></pre>

<p>or you directly pass the source file URI to <code>g5k-campaign</code> (but you can&rsquo;t make changes):</p>

<pre><code>g5k-campaign -i https://github.com/grid5000/tutorials\
/raw/master/api/2.0/g5k-campaign-tutorial.rb \
&mdash;gateway access.grid5000.fr \
-u login
SimpleCustomEngine
</code></pre>

<p>As a side-note, if you are in the process of developing or modyfing an
engine, the <code>&mdash;dev</code> option of <code>g5k-campaign</code> is very useful ;&ndash;)</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-Advanced_example'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Advanced_example">&#182;</a>
        </div>
        <h2>Advanced example</h2>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-25'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-25">&#182;</a>
        </div>
        <p>One of the interesting feature of <code>g5k-campaign</code> is that you can reuse
existing engines by creating a subclass. Let&rsquo;s say you&rsquo;d like to execute the
previous workflow on more than one site, here is a way to do it.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-26'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-26">&#182;</a>
        </div>
        <p>Note how we inherit from <code>SimpleCustomEngine</code>:</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="k">class</span> <span class="nc">Grid</span> <span class="o">&lt;</span> <span class="no">SimpleCustomEngine</span>
  <span class="n">set</span> <span class="ss">:site</span><span class="p">,</span> <span class="ss">:all</span> <span class="c1"># :all or :rennes or [:rennes, :nancy] or...</span>

  <span class="n">before</span> <span class="ss">:reserve!</span> <span class="k">do</span> <span class="o">|</span><span class="n">env</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="o">|</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span> <span class="s2">&quot;Reserving nodes on </span><span class="si">#{</span><span class="n">site</span><span class="si">}</span><span class="s2"> sites...&quot;</span>
    <span class="n">env</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-27'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-27">&#182;</a>
        </div>
        <p>Here we change what is done by the default <code>:reserve!</code> hook, so that we
can launch the reservation process on more than one site at a time.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">on</span> <span class="ss">:reserve!</span> <span class="k">do</span> <span class="o">|</span><span class="n">env</span><span class="p">,</span> <span class="n">block</span><span class="o">|</span></pre></div>
      </td>
    </tr>
    <tr id='section-28'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-28">&#182;</a>
        </div>
        <p>We make use of the <code>how_many?</code> helper function which returns the number of available nodes on each site (see <a href="http://g5k-campaign.gforge.inria.fr/Grid5000/Campaign/Engine.html#how_many%3F-instance_method">http://g5k-campaign.gforge.inria.fr/Grid5000/Campaign/Engine.html#how_many%3F-instance_method</a>).</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">status</span> <span class="o">=</span> <span class="n">how_many?</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span> <span class="s2">&quot;Status=</span><span class="si">#{</span><span class="n">status</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">case</span> <span class="n">env</span><span class="o">[</span><span class="ss">:site</span><span class="o">].</span><span class="n">to_s</span>
    <span class="k">when</span> <span class="s2">&quot;all&quot;</span>
      <span class="n">sites</span> <span class="o">=</span> <span class="n">status</span><span class="o">.</span><span class="n">keys</span>
    <span class="k">when</span> <span class="s2">&quot;any&quot;</span></pre></div>
      </td>
    </tr>
    <tr id='section-29'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-29">&#182;</a>
        </div>
        <p>If any site will do, take the one with the most nodes available:</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">sites</span> <span class="o">=</span> <span class="o">[</span><span class="n">status</span><span class="o">.</span><span class="n">sort_by</span><span class="p">{</span><span class="o">|</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span><span class="p">}</span><span class="o">.</span><span class="n">last</span><span class="o">[</span><span class="mi">0</span><span class="o">]]</span>
    <span class="k">else</span>
      <span class="n">sites</span> <span class="o">=</span> <span class="o">[</span><span class="n">env</span><span class="o">[</span><span class="ss">:site</span><span class="o">]].</span><span class="n">flatten</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-30'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-30">&#182;</a>
        </div>
        <p><code>g5k-campaign</code> comes with helper methods for parallel execution (see <a href="http://g5k-campaign.gforge.inria.fr/Grid5000/Campaign/Parallel.html">http://g5k-campaign.gforge.inria.fr/Grid5000/Campaign/Parallel.html</a>), whose usage is demonstrated here.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">env</span><span class="o">[</span><span class="ss">:parallel_reserve!</span><span class="o">]</span> <span class="o">=</span> <span class="n">parallel</span><span class="p">(</span><span class="ss">:ignore_thread_exceptions</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span>
    <span class="n">envs</span> <span class="o">=</span> <span class="o">[]</span>

    <span class="n">sites</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">uid</span><span class="o">|</span>
      <span class="k">if</span> <span class="n">status</span><span class="o">[</span><span class="n">uid</span><span class="o">].</span><span class="n">nil?</span> <span class="o">||</span> <span class="n">status</span><span class="o">[</span><span class="n">uid</span><span class="o">]</span> <span class="o">&lt;</span> <span class="mi">5</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span> <span class="s2">&quot;Skipped </span><span class="si">#{</span><span class="n">uid</span><span class="si">}</span><span class="s2"> since it has only </span><span class="si">#{</span><span class="n">status</span><span class="o">[</span><span class="n">uid</span><span class="o">]</span><span class="si">}</span><span class="s2"> nodes that match our requirements.&quot;</span>
      <span class="k">else</span>
        <span class="n">new_env</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="ss">:site</span> <span class="o">=&gt;</span> <span class="n">uid</span><span class="p">)</span>
        <span class="n">env</span><span class="o">[</span><span class="ss">:parallel_reserve!</span><span class="o">].</span><span class="n">add</span><span class="p">(</span><span class="n">new_env</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">env</span><span class="o">|</span>
          <span class="n">reserve!</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
        <span class="k">end</span>
        <span class="n">envs</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">new_env</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-31'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-31">&#182;</a>
        </div>
        <p>Master thread must wait for all other threads termination:</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">env</span><span class="o">[</span><span class="ss">:parallel_reserve!</span><span class="o">].</span><span class="n">loop!</span></pre></div>
      </td>
    </tr>
    <tr id='section-32'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-32">&#182;</a>
        </div>
        <p>At the end of the whole workflow, automatically display the URL at which
a graphical view of the metrics can be seen.
Skip the sites where the reservation failed.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">metrics_query</span> <span class="o">=</span> <span class="n">envs</span><span class="o">.</span><span class="n">reject</span><span class="p">{</span><span class="o">|</span><span class="n">e</span><span class="o">|</span> <span class="n">e</span><span class="o">[</span><span class="ss">:job</span><span class="o">].</span><span class="n">nil?</span><span class="p">}</span><span class="o">.</span><span class="n">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span>
      <span class="o">[</span><span class="n">e</span><span class="o">[</span><span class="ss">:site</span><span class="o">]</span><span class="p">,</span> <span class="n">e</span><span class="o">[</span><span class="ss">:job</span><span class="o">][</span><span class="s1">&#39;uid&#39;</span><span class="o">]].</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
    <span class="k">end</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span> <span class="s2">&quot;You can get a graph of your metrics at https://api.grid5000.fr/sid/ui/metrics.html?jobs=</span><span class="si">#{</span><span class="n">metrics_query</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="n">env</span>
  <span class="k">end</span>

  <span class="n">before</span> <span class="ss">:execute!</span> <span class="k">do</span> <span class="o">|</span><span class="n">env</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="o">|</span></pre></div>
      </td>
    </tr>
    <tr id='section-33'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-33">&#182;</a>
        </div>
        <p>Call <code>#wait!</code> on the parallel object if you want to synchronize all
threads at some point. In this example, the execution phase will be
launched only after all the other threads are arrived here.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span> <span class="s2">&quot;[</span><span class="si">#{</span><span class="n">env</span><span class="o">[</span><span class="ss">:site</span><span class="o">]</span><span class="si">}</span><span class="s2">] Waiting for other deployments to finish...&quot;</span>
    <span class="n">env</span><span class="o">[</span><span class="ss">:parallel_reserve!</span><span class="o">].</span><span class="n">wait!</span>
    <span class="n">env</span>
  <span class="k">end</span>

  <span class="n">after</span> <span class="ss">:execute!</span> <span class="k">do</span> <span class="o">|</span><span class="n">env</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="o">|</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span> <span class="s2">&quot;[</span><span class="si">#{</span><span class="n">env</span><span class="o">[</span><span class="ss">:site</span><span class="o">]</span><span class="si">}</span><span class="s2">] Done!&quot;</span>
    <span class="n">env</span>
  <span class="k">end</span>

<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-Running_your_engines_(with_inheritance)'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Running_your_engines_(with_inheritance)">&#182;</a>
        </div>
        <h2>Running your engines (with inheritance)</h2>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-35'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-35">&#182;</a>
        </div>
        <p>If all your engines are declared in the same file, just use the same command
as before but replace <code>SimpleCustomEngine</code> with <code>Grid</code> in the command (please replace <code>login</code> with your login):</p>

<pre><code>g5k-campaign -i https://github.com/grid5000/tutorials\
/raw/master/api/2.0/g5k-campaign-tutorial.rb \
&mdash;gateway access.grid5000.fr \
-u login
Grid
</code></pre>

<p>If you have engines declared in more than one file, just use multiple <code>-i</code>
flags to include them all.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-Conclusion'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Conclusion">&#182;</a>
        </div>
        <h2>Conclusion</h2>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-37'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-37">&#182;</a>
        </div>
        <p>This concludes our tutorial, please see the <a href="http://g5k-campaign.gforge.inria.fr/">documentation</a> and
<a href="https://gforge.inria.fr/plugins/scmgit/cgi-bin/gitweb.cgi?p=g5k-campaign/g5k-campaign.git;a=tree;f=examples;hb=HEAD">examples</a> for more advanced usages,
including grid reservation, multiple deployments, notifications, etc.</p>

      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
